<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/sandstone/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-light.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-grid.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-theme-balham.min.css" rel="stylesheet" type="text/css">
        <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <p id="loading">Loading ...</p>
        <div id="app"></div>
    </body>
    <script src="https://cdn.jsdelivr.net/gh/scicloj/gorilla-notes@master/dist/0.5.1/main.js"></script>
    <script>
     shadow.loader.load("main");
     gorilla_notes.main.main_BANG_(false, "{:options {:reverse-notes? false, :header? false, :notes-in-cards? false, :initially-collapse? false, :auto-scroll? false, :custom-header [:div {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} \"(notespace)\" [:p \"Fri Jan 22 16:32:45 IST 2021\"] nil [:hr]], :custom-footer [:div [:hr] [:hr]]}, :ids [\"291\" \"292\" \"293\" \"294\" \"295\" \"296\" \"297\" \"298\" \"299\" \"300\" \"301\" \"302\" \"303\" \"304\" \"305\" \"306\" \"307\" \"308\" \"309\" \"310\" \"311\" \"312\" \"313\" \"314\" \"315\" \"316\" \"317\" \"318\" \"319\" \"320\" \"321\" \"322\" \"323\" \"324\" \"325\" \"326\" \"327\"], :id->content {\"303\" [:div nil [:div [:p/markdown \"Given a point in time, we want to find the row-numbers of the last few days.\"]]], \"321\" [:div nil [:div [:p/markdown \"For every moment in time, we will compute the average of the `:x` column valeus at the last 5 days. Then, we will compute the standard deviation of all these averages.\"]]], \"305\" [:div [:p/code {:code \"(defn row-numbers-of-last-few-days-by-argfilter [reference-datetime num-days]\\n  (let [end   (datetime/local-date-time->milliseconds-since-epoch\\n               reference-datetime)\\n        start (- end\\n                 (* num-days milliseconds-in-an-day))]\\n    (->> ds\\n         :datetime\\n         (argops/argfilter (fn [datetime]\\n                             (<= start\\n                                 (datetime/local-date-time->milliseconds-since-epoch\\n                                  datetime)\\n                                 end))))))\", :bg-class \"bg-light\"}] [:div nil]], \"300\" [:div nil [:div [:p/markdown \"## Finding the row-numbers of the last few days\"]]], \"315\" [:div nil [:div [:p/markdown \"Checking the same example:\"]]], \"304\" [:div nil [:div [:p/markdown \"First, let us do it using `argfilter`. We will use milliseconds arithmetic, though we could work directly with datetimes.\"]]], \"295\" [:div [:p/code {:code \"(def n 10000)\", :bg-class \"bg-light\"}] [:div nil]], \"302\" [:div [:p/code {:code \"milliseconds-in-an-day\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"86400000\\n\"}]]], \"299\" [:div [:p/code {:code \"^kind/dataset\\nds\", :bg-class \"bg-light\"}] [:div [:div {:class \"table table-striped table-hover table-condensed table-responsive\", :style {:height \"400px\"}} [:p/markdown \"_unnamed [10000 3]:\\n\\n|           :datetime |         :x | :i |\\n|---------------------|------------|----|\\n| 1970-01-02T04:21:54 | 0.76706392 |  0 |\\n| 1970-01-03T08:50:58 | 0.09354111 |  1 |\\n| 1970-01-04T07:48:48 | 0.88760162 |  2 |\\n| 1970-01-04T11:46:21 | 0.38389925 |  3 |\\n| 1970-01-04T19:33:13 | 0.21500645 |  4 |\\n| 1970-01-04T21:49:07 | 0.99208403 |  5 |\\n| 1970-01-07T01:07:59 | 0.38424197 |  6 |\\n| 1970-01-07T07:36:28 | 0.89053569 |  7 |\\n|    1970-01-09T15:08 | 0.69726419 |  8 |\\n| 1970-01-11T03:18:25 | 0.88921733 |  9 |\\n| 1970-01-12T10:33:14 | 0.34906746 | 10 |\\n| 1970-01-13T09:55:57 | 0.29040072 | 11 |\\n| 1970-01-20T19:50:30 | 0.75577405 | 12 |\\n| 1970-01-21T11:10:43 | 0.18333687 | 13 |\\n| 1970-01-22T05:26:33 | 0.41527691 | 14 |\\n| 1970-01-23T03:14:29 | 0.86205849 | 15 |\\n| 1970-01-23T21:14:16 | 0.49232012 | 16 |\\n| 1970-01-25T07:17:48 | 0.00221930 | 17 |\\n| 1970-01-26T01:24:46 | 0.29521967 | 18 |\\n| 1970-01-26T10:08:24 | 0.30179790 | 19 |\\n| 1970-01-26T14:35:34 | 0.90593074 | 20 |\\n| 1970-01-27T20:33:26 | 0.14498354 | 21 |\\n| 1970-01-30T06:53:13 | 0.94468767 | 22 |\\n| 1970-01-31T11:45:12 | 0.73321370 | 23 |\\n| 1970-01-31T17:19:12 | 0.07096574 | 24 |\\n\"]]]], \"318\" [:div [:p/code {:code \"(defn compute-with-time-measurement [f]\\n  (let [start-time (datetime/instant)\\n        result (f)\\n        end-time (datetime/instant)]\\n    {:result result\\n     :duration (datetime/between start-time end-time :milliseconds)}))\", :bg-class \"bg-light\"}] [:div nil]], \"296\" [:div [:p/code {:code \"(defn random-datetime []\\n  (datetime/milliseconds->datetime :local-date-time\\n                                   (* 1000 (rand-int 999999999))))\", :bg-class \"bg-light\"}] [:div nil]], \"326\" [:div nil [:div [:p/markdown \"Same result, different durations.\"]]], \"297\" [:div [:p/code {:code \"(random-datetime)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.time.LocalDateTime 0x42c18a48 \\\"1975-11-29T04:09:39\\\"]\\n\"}]]], \"294\" [:div nil [:div [:p/markdown \"## Example data\"]]], \"311\" [:div nil [:div [:p/markdown \"You can verify by looking at the dataset above.\"]]], \"307\" [:div [:p/code {:code \"(def datetime20\\n  (-> ds\\n      :datetime\\n      (nth 20)))\", :bg-class \"bg-light\"}] [:div nil]], \"312\" [:div nil [:div [:p/markdown \"Now, let us do the same using an index structure.\"]]], \"293\" [:div [:p/code {:code \"(import java.util.TreeMap)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"java.util.TreeMap\\n\"}]]], \"308\" [:div [:p/code {:code \"datetime20\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.time.LocalDateTime 0x304636b2 \\\"1970-01-26T14:35:34\\\"]\\n\"}]]], \"313\" [:div [:p/code {:code \"(def index\\n  (TreeMap. ^java.util.Map\\n            (zipmap (dtype/emap datetime/local-date-time->milliseconds-since-epoch\\n                                :int64\\n                                (:datetime ds))\\n                    (dtype/make-reader :int64 n idx))))\", :bg-class \"bg-light\"}] [:div nil]], \"320\" [:div nil [:div [:p/markdown \"## Computing a rolling time window average\"]]], \"325\" [:div [:p/code {:code \"(compute-with-time-measurement\\n (fn []\\n   (->> ds\\n        :datetime\\n        (dtype/emap (fn [datetime]\\n                      (let [row-numbers (row-numbers-of-last-few-days-by-index\\n                                         datetime\\n                                         5)]\\n                        (-> ds\\n                            (tablecloth/select-rows row-numbers)\\n                            :x\\n                            fun/mean)))\\n                    :float64)\\n        fun/standard-deviation)))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result 0.13621575687285056, :duration 247}\\n\"}]]], \"306\" [:div nil [:div [:p/markdown \"Let us try this on some point in time.\"]]], \"316\" [:div [:p/code {:code \"(row-numbers-of-last-few-days-by-index\\n datetime20\\n 14)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.util.AbstractMap$2 0x6ba793e0 \\\"[11, 12, 13, 14, 15, 16, 17, 18, 19, 20]\\\"]\\n\"}]]], \"324\" [:div nil [:div [:p/markdown \"Now, let us do it in the index way.\"]]], \"301\" [:div [:p/code {:code \"(def milliseconds-in-an-day (* 24 60 60 1000))\", :bg-class \"bg-light\"}] [:div nil]], \"317\" [:div nil [:div [:p/markdown \"## Measuring time\"]]], \"319\" [:div [:p/code {:code \"(compute-with-time-measurement #(Thread/sleep 1000))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result nil, :duration 1000}\\n\"}]]], \"298\" [:div [:p/code {:code \"(def ds\\n  (-> {:datetime (dtype/make-reader :local-date-time n (random-datetime))\\n       :x        (repeatedly n rand)}\\n      tablecloth/dataset\\n      (tablecloth/order-by :datetime)\\n      (tablecloth/add-or-replace-column :i (dtype/make-reader :int64 n idx))))\", :bg-class \"bg-light\"}] [:div nil]], \"322\" [:div nil [:div [:p/markdown \"First, let us do it in the argfilter way.\"]]], \"310\" [:div [:p/code {:code \"(row-numbers-of-last-few-days-by-argfilter\\n datetime20\\n 5)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#list<int32>[7]\\n[14, 15, 16, 17, 18, 19, 20, ]\\n\"}]]], \"327\" [:div nil [:div [:p/markdown \".\"]]], \"291\" [:div nil [:div [:p/markdown \"# Rolling time-window -- checking different implementations\"]]], \"323\" [:div [:p/code {:code \"(compute-with-time-measurement\\n (fn []\\n   (->> ds\\n        :datetime\\n        (dtype/emap (fn [datetime]\\n                      (let [row-numbers (row-numbers-of-last-few-days-by-argfilter\\n                                         datetime\\n                                         5)]\\n                        (-> ds\\n                            (tablecloth/select-rows row-numbers)\\n                            :x\\n                            fun/mean)))\\n                    :float64)\\n        fun/standard-deviation)))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result 0.13621575687285056, :duration 30874}\\n\"}]]], \"292\" [:div [:p/code {:code \"(require '[notespace.kinds :as kind]\\n         '[tablecloth.api :as tablecloth]\\n         '[tech.v3.datatype :as dtype]\\n         '[tech.v3.datatype.functional :as fun]\\n         '[tech.v3.datatype.datetime :as datetime]\\n         '[tech.v3.datatype.argops :as argops])\", :bg-class \"bg-light\"}] [:div nil]], \"309\" [:div nil [:div [:p/markdown \"What row numbers are relevant for the last 5 with respect to that instance?\"]]], \"314\" [:div [:p/code {:code \"(defn row-numbers-of-last-few-days-by-index [reference-datetime num-days]\\n  (let [end   (datetime/local-date-time->milliseconds-since-epoch\\n               reference-datetime)\\n        start (- end\\n                 (* num-days milliseconds-in-an-day))]\\n    (-> (.subMap ^TreeMap\\n                 index\\n                 start\\n                 true\\n                 end\\n                 true)\\n        (.values))))\", :bg-class \"bg-light\"}] [:div nil]]}}");
     document.getElementById("loading").remove();
    </script>
</html>
