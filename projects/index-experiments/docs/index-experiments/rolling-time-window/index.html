<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/sandstone/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-light.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-grid.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-theme-balham.min.css" rel="stylesheet" type="text/css">
        <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <p id="loading">Loading ...</p>
        <div id="app"></div>
    </body>
    <script src="https://cdn.jsdelivr.net/gh/scicloj/gorilla-notes@master/dist/0.5.1/main.js"></script>
    <script>
     shadow.loader.load("main");
     gorilla_notes.main.main_BANG_(false, "{:options {:reverse-notes? false, :header? false, :notes-in-cards? false, :initially-collapse? false, :auto-scroll? false, :custom-header [:div {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} \"(notespace)\" [:p \"Fri Jan 22 16:48:34 IST 2021\"] nil [:hr]], :custom-footer [:div [:hr] [:hr]]}, :ids [\"331\" \"332\" \"333\" \"334\" \"335\" \"336\" \"337\" \"338\" \"339\" \"300\" \"340\" \"341\" \"342\" \"304\" \"343\" \"344\" \"307\" \"345\" \"346\" \"347\" \"348\" \"349\" \"350\" \"351\" \"352\" \"353\" \"354\" \"355\" \"356\" \"357\" \"358\" \"322\" \"359\" \"360\" \"361\" \"362\" \"397\"], :id->content {\"334\" [:div nil [:div [:p/markdown \"## Example data\"]]], \"359\" [:div [:p/code {:code \"(compute-with-time-measurement\\n (fn []\\n   (->> ds\\n        :datetime\\n        (dtype/emap (fn [datetime]\\n                      (let [row-numbers (row-numbers-of-last-few-days-by-argfilter\\n                                         datetime\\n                                         5)]\\n                        (-> ds\\n                            (tablecloth/select-rows row-numbers)\\n                            :x\\n                            fun/mean)))\\n                    :float64)\\n        fun/standard-deviation)))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result 0.13604629281581715, :duration 32546}\\n\"}]]], \"343\" [:div [:p/code {:code \"(defn row-numbers-of-last-few-days-by-argfilter [reference-datetime num-days]\\n  (let [end   (datetime/local-date-time->milliseconds-since-epoch\\n               reference-datetime)\\n        start (- end\\n                 (* num-days milliseconds-in-an-day))]\\n    (->> ds\\n         :datetime\\n         (argops/argfilter (fn [datetime]\\n                             (<= start\\n                                 (datetime/local-date-time->milliseconds-since-epoch\\n                                  datetime)\\n                                 end))))))\", :bg-class \"bg-light\"}] [:div nil]], \"300\" [:div nil [:div [:p/markdown \"## Finding the row-numbers of the last few days\"]]], \"364\" [:div nil [:div [:p/markdown \".\"]]], \"304\" [:div nil [:div [:p/markdown \"First, let us do it using `argfilter`. We will use milliseconds arithmetic, though we could work directly with datetimes.\"]]], \"346\" [:div nil [:div [:p/markdown \"What row numbers are relevant for the last 5 with respect to that instance?\"]]], \"336\" [:div [:p/code {:code \"(defn random-datetime []\\n  (datetime/milliseconds->datetime :local-date-time\\n                                   (* 1000 (rand-int 999999999))))\", :bg-class \"bg-light\"}] [:div nil]], \"355\" [:div [:p/code {:code \"(defn compute-with-time-measurement [f]\\n  (let [start-time (datetime/instant)\\n        result (f)\\n        end-time (datetime/instant)]\\n    {:result result\\n     :duration (datetime/between start-time end-time :milliseconds)}))\", :bg-class \"bg-light\"}] [:div nil]], \"332\" [:div [:p/code {:code \"(require '[notespace.kinds :as kind]\\n         '[tablecloth.api :as tablecloth]\\n         '[tech.v3.datatype :as dtype]\\n         '[tech.v3.datatype.functional :as fun]\\n         '[tech.v3.datatype.datetime :as datetime]\\n         '[tech.v3.datatype.argops :as argops])\", :bg-class \"bg-light\"}] [:div nil]], \"358\" [:div nil [:div [:p/markdown \"For every moment in time, we will compute the average of the `:x` column valeus at the last 5 days. Then, we will compute the standard deviation of all these averages.\"]]], \"345\" [:div [:p/code {:code \"datetime20\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.time.LocalDateTime 0x55fa1452 \\\"1970-01-25T00:13:24\\\"]\\n\"}]]], \"338\" [:div [:p/code {:code \"(def ds\\n  (-> {:datetime (dtype/make-reader :local-date-time n (random-datetime))\\n       :x        (repeatedly n rand)}\\n      tablecloth/dataset\\n      (tablecloth/order-by :datetime)\\n      (tablecloth/add-or-replace-column :i (dtype/make-reader :int64 n idx))))\", :bg-class \"bg-light\"}] [:div nil]], \"354\" [:div nil [:div [:p/markdown \"## Measuring time\"]]], \"362\" [:div nil [:div [:p/markdown \"## Conclusion\"]]], \"350\" [:div [:p/code {:code \"(def index\\n  (TreeMap. ^java.util.Map\\n            (zipmap (dtype/emap datetime/local-date-time->milliseconds-since-epoch\\n                                :int64\\n                                (:datetime ds))\\n                    (dtype/make-reader :int64 n idx))))\", :bg-class \"bg-light\"}] [:div nil]], \"356\" [:div [:p/code {:code \"(compute-with-time-measurement #(Thread/sleep 1000))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result nil, :duration 1000}\\n\"}]]], \"341\" [:div [:p/code {:code \"milliseconds-in-an-day\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"86400000\\n\"}]]], \"357\" [:div nil [:div [:p/markdown \"## Computing a rolling time window average\"]]], \"307\" [:div [:p/code {:code \"(def datetime20\\n  (-> ds\\n      :datetime\\n      (nth 20)))\", :bg-class \"bg-light\"}] [:div nil]], \"337\" [:div [:p/code {:code \"(random-datetime)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.time.LocalDateTime 0x58aebfe7 \\\"1996-04-12T02:21:27\\\"]\\n\"}]]], \"347\" [:div [:p/code {:code \"(row-numbers-of-last-few-days-by-argfilter\\n datetime20\\n 5)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#list<int32>[6]\\n[15, 16, 17, 18, 19, 20, ]\\n\"}]]], \"335\" [:div [:p/code {:code \"(def n 10000)\", :bg-class \"bg-light\"}] [:div nil]], \"331\" [:div nil [:div [:p/markdown \"# Rolling time-window -- checking different implementations\"]]], \"352\" [:div nil [:div [:p/markdown \"Checking the same example:\"]]], \"360\" [:div nil [:div [:p/markdown \"Now, let us do it in the index way.\"]]], \"344\" [:div nil [:div [:p/markdown \"Let us try this on some point in time.\"]]], \"353\" [:div [:p/code {:code \"(row-numbers-of-last-few-days-by-index\\n datetime20\\n 14)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.util.AbstractMap$2 0x48ea79f6 \\\"[10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20]\\\"]\\n\"}]]], \"340\" [:div [:p/code {:code \"(def milliseconds-in-an-day (* 24 60 60 1000))\", :bg-class \"bg-light\"}] [:div nil]], \"342\" [:div nil [:div [:p/markdown \"Given a point in time, we want to find the row-numbers of the last few days.\"]]], \"322\" [:div nil [:div [:p/markdown \"First, let us do it in the argfilter way.\"]]], \"348\" [:div nil [:div [:p/markdown \"You can verify by looking at the dataset above.\"]]], \"339\" [:div [:p/code {:code \"^kind/dataset\\nds\", :bg-class \"bg-light\"}] [:div [:div {:class \"table table-striped table-hover table-condensed table-responsive\", :style {:height \"400px\"}} [:p/markdown \"_unnamed [10000 3]:\\n\\n|           :datetime |         :x | :i |\\n|---------------------|------------|----|\\n| 1970-01-01T06:05:43 | 0.89399098 |  0 |\\n| 1970-01-01T16:48:36 | 0.19052690 |  1 |\\n| 1970-01-02T03:18:05 | 0.98015865 |  2 |\\n| 1970-01-03T23:05:40 | 0.33153903 |  3 |\\n| 1970-01-05T15:41:19 | 0.26420475 |  4 |\\n| 1970-01-05T17:54:49 | 0.35868289 |  5 |\\n| 1970-01-06T13:55:31 | 0.83768344 |  6 |\\n| 1970-01-06T13:57:50 | 0.51606502 |  7 |\\n| 1970-01-06T17:32:26 | 0.82863325 |  8 |\\n| 1970-01-08T11:33:55 | 0.49583459 |  9 |\\n| 1970-01-11T05:32:52 | 0.79278524 | 10 |\\n| 1970-01-13T19:31:20 | 0.82927831 | 11 |\\n| 1970-01-14T21:37:17 | 0.85531988 | 12 |\\n| 1970-01-16T11:34:37 | 0.28368446 | 13 |\\n| 1970-01-19T10:30:28 | 0.81453021 | 14 |\\n| 1970-01-20T11:05:29 | 0.78839813 | 15 |\\n| 1970-01-21T07:39:22 | 0.59477441 | 16 |\\n| 1970-01-23T09:10:58 | 0.82650995 | 17 |\\n| 1970-01-24T05:43:41 | 0.83754483 | 18 |\\n| 1970-01-24T12:52:24 | 0.83604982 | 19 |\\n| 1970-01-25T00:13:24 | 0.64758669 | 20 |\\n| 1970-01-27T04:22:14 | 0.10024125 | 21 |\\n| 1970-01-28T01:41:07 | 0.06588395 | 22 |\\n| 1970-01-28T13:20:33 | 0.70707883 | 23 |\\n| 1970-01-29T10:41:47 | 0.58686139 | 24 |\\n\"]]]], \"333\" [:div [:p/code {:code \"(import java.util.TreeMap)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"java.util.TreeMap\\n\"}]]], \"361\" [:div [:p/code {:code \"(compute-with-time-measurement\\n (fn []\\n   (->> ds\\n        :datetime\\n        (dtype/emap (fn [datetime]\\n                      (let [row-numbers (row-numbers-of-last-few-days-by-index\\n                                         datetime\\n                                         5)]\\n                        (-> ds\\n                            (tablecloth/select-rows row-numbers)\\n                            :x\\n                            fun/mean)))\\n                    :float64)\\n        fun/standard-deviation)))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result 0.13604629281581715, :duration 212}\\n\"}]]], \"349\" [:div nil [:div [:p/markdown \"Now, let us do the same using an index structure.\"]]], \"397\" [:div nil [:div [:p/markdown \"Same result, different durations.\"]]], \"351\" [:div [:p/code {:code \"(defn row-numbers-of-last-few-days-by-index [reference-datetime num-days]\\n  (let [end   (datetime/local-date-time->milliseconds-since-epoch\\n               reference-datetime)\\n        start (- end\\n                 (* num-days milliseconds-in-an-day))]\\n    (-> (.subMap ^TreeMap\\n                 index\\n                 start\\n                 true\\n                 end\\n                 true)\\n        (.values))))\", :bg-class \"bg-light\"}] [:div nil]]}}");
     document.getElementById("loading").remove();
    </script>
</html>
