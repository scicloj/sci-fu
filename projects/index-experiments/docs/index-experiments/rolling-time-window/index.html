<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://stackpath.bootstrapcdn.com/bootswatch/4.5.0/sandstone/bootstrap.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.6.0/styles/solarized-light.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-grid.min.css" rel="stylesheet" type="text/css">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/24.0.0/styles/ag-theme-balham.min.css" rel="stylesheet" type="text/css">
        <link href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" rel="stylesheet" type="text/css">
    </head>
    <body>
        <p id="loading">Loading ...</p>
        <div id="app"></div>
    </body>
    <script src="https://cdn.jsdelivr.net/gh/scicloj/gorilla-notes@master/dist/0.5.1/main.js"></script>
    <script>
     shadow.loader.load("main");
     gorilla_notes.main.main_BANG_(false, "{:options {:reverse-notes? false, :header? false, :notes-in-cards? false, :initially-collapse? false, :auto-scroll? false, :custom-header [:div {:style {:font-style \"italic\", :font-family \"\\\"Lucida Console\\\", Courier, monospace\"}} \"(notespace)\" [:p \"Fri Jan 22 17:17:25 IST 2021\"] nil [:hr]], :custom-footer [:div [:hr] [:hr]]}, :ids [\"399\" \"400\" \"401\" \"402\" \"335\" \"336\" \"403\" \"404\" \"405\" \"300\" \"340\" \"341\" \"342\" \"304\" \"406\" \"407\" \"307\" \"408\" \"409\" \"410\" \"411\" \"412\" \"350\" \"413\" \"352\" \"414\" \"415\" \"416\" \"417\" \"418\" \"358\" \"322\" \"419\" \"360\" \"420\" \"362\" \"428\"], :id->content {\"402\" [:div nil [:div [:p/markdown \"## Example data\"]]], \"419\" [:div [:p/code {:code \"(compute-with-time-measurement\\n (fn []\\n   (->> ds\\n        :datetime\\n        (dtype/emap (fn [datetime]\\n                      (let [row-numbers (row-numbers-of-last-few-days-by-argfilter\\n                                         datetime\\n                                         5)]\\n                        (-> ds\\n                            (tablecloth/select-rows row-numbers)\\n                            :x\\n                            fun/mean)))\\n                    :float64)\\n        fun/standard-deviation)))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result 0.13938182798346027, :duration 32139}\\n\"}]]], \"415\" [:div nil [:div [:p/markdown \"## Measuring time\"]]], \"413\" [:div [:p/code {:code \"(defn row-numbers-of-last-few-days-by-index [reference-datetime num-days]\\n  (let [end   (datetime/local-date-time->milliseconds-since-epoch\\n               reference-datetime)\\n        start (- end\\n                 (* num-days milliseconds-in-an-day))]\\n    (-> (.subMap ^TreeMap\\n                 index\\n                 start\\n                 true\\n                 end\\n                 true)\\n        (.values))))\", :bg-class \"bg-light\"}] [:div nil]], \"408\" [:div [:p/code {:code \"datetime20\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.time.LocalDateTime 0x72bfb5d9 \\\"1970-01-27T08:42:35\\\"]\\n\"}]]], \"411\" [:div nil [:div [:p/markdown \"You can verify by looking at the dataset above.\"]]], \"300\" [:div nil [:div [:p/markdown \"## Finding the row-numbers of the last few days\"]]], \"364\" [:div nil [:div [:p/markdown \".\"]]], \"404\" [:div [:p/code {:code \"(def ds\\n  (-> {:datetime (dtype/make-reader :local-date-time n (random-datetime))\\n       :x        (repeatedly n rand)}\\n      tablecloth/dataset\\n      (tablecloth/order-by :datetime)\\n      (tablecloth/add-or-replace-column :i (dtype/make-reader :int64 n idx))))\", :bg-class \"bg-light\"}] [:div nil]], \"304\" [:div nil [:div [:p/markdown \"First, let us do it using `argfilter`. We will use milliseconds arithmetic, though we could work directly with datetimes.\"]]], \"414\" [:div [:p/code {:code \"(row-numbers-of-last-few-days-by-index\\n datetime20\\n 5)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.util.AbstractMap$2 0x6d58a294 \\\"[16, 17, 18, 19, 20]\\\"]\\n\"}]]], \"336\" [:div [:p/code {:code \"(defn random-datetime []\\n  (datetime/milliseconds->datetime :local-date-time\\n                                   (* 1000 (rand-int 999999999))))\", :bg-class \"bg-light\"}] [:div nil]], \"358\" [:div nil [:div [:p/markdown \"For every moment in time, we will compute the average of the `:x` column valeus at the last 5 days. Then, we will compute the standard deviation of all these averages.\"]]], \"405\" [:div [:p/code {:code \"^kind/dataset\\nds\", :bg-class \"bg-light\"}] [:div [:div {:class \"table table-striped table-hover table-condensed table-responsive\", :style {:height \"400px\"}} [:p/markdown \"_unnamed [10000 3]:\\n\\n|           :datetime |         :x | :i |\\n|---------------------|------------|----|\\n| 1970-01-01T09:54:48 | 0.78312872 |  0 |\\n| 1970-01-01T20:19:02 | 0.49796707 |  1 |\\n| 1970-01-02T07:35:20 | 0.46185129 |  2 |\\n| 1970-01-04T07:58:24 | 0.54128552 |  3 |\\n| 1970-01-06T16:14:42 | 0.63673246 |  4 |\\n| 1970-01-07T15:59:37 | 0.74290577 |  5 |\\n| 1970-01-08T19:46:40 | 0.85416636 |  6 |\\n| 1970-01-08T20:44:34 | 0.69376938 |  7 |\\n| 1970-01-08T23:24:32 | 0.80192308 |  8 |\\n| 1970-01-09T18:45:18 | 0.04252529 |  9 |\\n| 1970-01-11T12:06:08 | 0.57615649 | 10 |\\n| 1970-01-11T14:47:03 | 0.07926822 | 11 |\\n| 1970-01-15T07:42:18 | 0.74216624 | 12 |\\n| 1970-01-18T07:13:15 | 0.99757853 | 13 |\\n| 1970-01-18T18:53:01 | 0.01485670 | 14 |\\n| 1970-01-19T23:11:50 | 0.08454038 | 15 |\\n| 1970-01-23T17:52:11 | 0.38466624 | 16 |\\n| 1970-01-23T22:22:18 | 0.24430615 | 17 |\\n| 1970-01-25T06:33:28 | 0.44131976 | 18 |\\n| 1970-01-26T10:32:38 | 0.16087228 | 19 |\\n| 1970-01-27T08:42:35 | 0.75478182 | 20 |\\n| 1970-01-30T01:31:51 | 0.12720533 | 21 |\\n| 1970-01-30T15:36:06 | 0.29074214 | 22 |\\n| 1970-01-31T06:44:07 | 0.37770958 | 23 |\\n| 1970-02-01T01:26:53 | 0.25993728 | 24 |\\n\"]]]], \"401\" [:div [:p/code {:code \"(import java.util.TreeMap)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"java.util.TreeMap\\n\"}]]], \"362\" [:div nil [:div [:p/markdown \"## Conclusion\"]]], \"350\" [:div [:p/code {:code \"(def index\\n  (TreeMap. ^java.util.Map\\n            (zipmap (dtype/emap datetime/local-date-time->milliseconds-since-epoch\\n                                :int64\\n                                (:datetime ds))\\n                    (dtype/make-reader :int64 n idx))))\", :bg-class \"bg-light\"}] [:div nil]], \"420\" [:div [:p/code {:code \"(compute-with-time-measurement\\n (fn []\\n   (->> ds\\n        :datetime\\n        (dtype/emap (fn [datetime]\\n                      (let [row-numbers (row-numbers-of-last-few-days-by-index\\n                                         datetime\\n                                         5)]\\n                        (-> ds\\n                            (tablecloth/select-rows row-numbers)\\n                            :x\\n                            fun/mean)))\\n                    :float64)\\n        fun/standard-deviation)))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result 0.13938182798346027, :duration 207}\\n\"}]]], \"341\" [:div [:p/code {:code \"milliseconds-in-an-day\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"86400000\\n\"}]]], \"428\" [:div nil [:div [:p/markdown \"Same result, different durations. The computational complexities are of order `n^2` and `n*log(n)`, resepectively, with respect to the data size `n`.\"]]], \"400\" [:div [:p/code {:code \"(require '[notespace.kinds :as kind]\\n         '[tablecloth.api :as tablecloth]\\n         '[tech.v3.datatype :as dtype]\\n         '[tech.v3.datatype.functional :as fun]\\n         '[tech.v3.datatype.datetime :as datetime]\\n         '[tech.v3.datatype.argops :as argops])\", :bg-class \"bg-light\"}] [:div nil]], \"307\" [:div [:p/code {:code \"(def datetime20\\n  (-> ds\\n      :datetime\\n      (nth 20)))\", :bg-class \"bg-light\"}] [:div nil]], \"335\" [:div [:p/code {:code \"(def n 10000)\", :bg-class \"bg-light\"}] [:div nil]], \"352\" [:div nil [:div [:p/markdown \"Checking the same example:\"]]], \"360\" [:div nil [:div [:p/markdown \"Now, let us do it in the index way.\"]]], \"399\" [:div nil [:div [:p/markdown \"# Rolling time-window -- checking different implementations\"]]], \"418\" [:div nil [:div [:p/markdown \"## Computing a rolling time window average\"]]], \"410\" [:div [:p/code {:code \"(row-numbers-of-last-few-days-by-argfilter\\n datetime20\\n 5)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#list<int32>[5]\\n[16, 17, 18, 19, 20, ]\\n\"}]]], \"416\" [:div [:p/code {:code \"(defn compute-with-time-measurement [f]\\n  (let [start-time (datetime/instant)\\n        result (f)\\n        end-time (datetime/instant)]\\n    {:result result\\n     :duration (datetime/between start-time end-time :milliseconds)}))\", :bg-class \"bg-light\"}] [:div nil]], \"403\" [:div [:p/code {:code \"(random-datetime)\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"#object[java.time.LocalDateTime 0x2290c9f9 \\\"1992-10-09T17:17:20\\\"]\\n\"}]]], \"409\" [:div nil [:div [:p/markdown \"What row numbers are relevant for the last 5 with respect to that instance?\"]]], \"406\" [:div [:p/code {:code \"(defn row-numbers-of-last-few-days-by-argfilter [reference-datetime num-days]\\n  (let [end   (datetime/local-date-time->milliseconds-since-epoch\\n               reference-datetime)\\n        start (- end\\n                 (* num-days milliseconds-in-an-day))]\\n    (->> ds\\n         :datetime\\n         (argops/argfilter (fn [datetime]\\n                             (<= start\\n                                 (datetime/local-date-time->milliseconds-since-epoch\\n                                  datetime)\\n                                 end))))))\", :bg-class \"bg-light\"}] [:div nil]], \"340\" [:div [:p/code {:code \"(def milliseconds-in-an-day (* 24 60 60 1000))\", :bg-class \"bg-light\"}] [:div nil]], \"342\" [:div nil [:div [:p/markdown \"Given a point in time, we want to find the row-numbers of the last few days.\"]]], \"322\" [:div nil [:div [:p/markdown \"First, let us do it in the argfilter way.\"]]], \"412\" [:div nil [:div [:p/markdown \"Now, let us do the same using an index structure.\"]]], \"407\" [:div nil [:div [:p/markdown \"Let us try this on some point in time.\"]]], \"417\" [:div [:p/code {:code \"(compute-with-time-measurement #(Thread/sleep 1000))\", :bg-class \"bg-light\"}] [:div [:p/code {:code \"{:result nil, :duration 1000}\\n\"}]]]}}");
     document.getElementById("loading").remove();
    </script>
</html>
